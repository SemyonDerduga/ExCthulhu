{% extends "base.html" %}

{% block title %}Прогнозирование - ExCthulhu{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-chart-line text-primary"></i>
                    Прогнозирование цен
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/">Главная</a></li>
                        <li class="breadcrumb-item active">Прогнозирование</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog"></i>
                        Настройки прогнозирования
                    </h5>
                </div>
                <div class="card-body">
                    <form id="forecastForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="forecastExchange" class="form-label">Биржа</label>
                                <select class="form-select" id="forecastExchange" required>
                                    <option value="">Выберите биржу...</option>
                                    <option value="binance">Binance</option>
                                    <option value="yobit">Yobit</option>
                                    <option value="hollaex">Hollaex</option>
                                    <option value="oceanex">Oceanex</option>
                                    <option value="poloniex">Poloniex</option>
                                    <option value="upbit">Upbit</option>
                                    <option value="exmo">Exmo</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="forecastSymbol" class="form-label">Торговая пара</label>
                                <input type="text" class="form-control" id="forecastSymbol" list="forecastSymbolList" placeholder="BTC/USDT" required data-bs-toggle="tooltip" title="Выберите валюту из списка или введите пару вручную">
                                <datalist id="forecastSymbolList"></datalist>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="forecastHours" class="form-label">Часов истории</label>
                                <input type="number" class="form-control" id="forecastHours" value="24" min="1" max="168" required>
                            </div>
                            <div class="col-md-4">
                                <label for="forecastMethod" class="form-label">Метод прогнозирования</label>
                                <select class="form-select" id="forecastMethod">
                                    <option value="mean" selected>Среднее значение</option>
                                    <option value="median">Медиана</option>
                                    <option value="ema">EMA</option>
                                    <option value="arima">ARIMA</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="forecastHorizon" class="form-label">Горизонт прогноза</label>
                                <input type="number" class="form-control" id="forecastHorizon" value="5" min="1" max="30" required>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-play"></i>
                                    Создать прогноз
                                </button>
                                
                                <div id="forecastLoading" class="loading mt-3" style="display: none;">
                                    <div class="progress mb-2">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" 
                                             style="width: 0%" 
                                             id="forecastProgressBar">0%</div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border text-primary me-2" role="status">
                                            <span class="visually-hidden">Загрузка...</span>
                                        </div>
                                        <span id="forecastLoadingText">Загрузка исторических данных...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i>
                        Информация
                    </h5>
                </div>
                <div class="card-body">
                    <div id="forecastInfo">
                        <p class="text-muted">Выберите параметры и создайте прогноз для получения информации</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area"></i>
                        График прогнозирования
                    </h5>
                </div>
                <div class="card-body">
                    <div id="forecastChart">
                        <p class="text-muted">График появится после создания прогноза</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line"></i>
                        Валидация прогноза
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="validationHours" class="form-label">Часов для валидации</label>
                            <input type="number" class="form-control" id="validationHours" value="6" min="1" max="24">
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-warning mt-4" onclick="validateForecast()">
                                <i class="fas fa-check-circle"></i>
                                Проверить точность прогноза
                            </button>
                        </div>
                    </div>
                    <div id="validationResults" class="mt-3">
                        <p class="text-muted">Нажмите кнопку для проверки точности прогноза</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', loadForecastCurrencies);
document.getElementById('forecastExchange').addEventListener('change', loadForecastCurrencies);

async function loadForecastCurrencies() {
    const exchange = document.getElementById('forecastExchange').value;
    const list = document.getElementById('forecastSymbolList');
    list.innerHTML = '';
    try {
        const response = await fetch(`/api/currencies/${exchange}`);
        const data = await response.json();
        data.currencies.forEach(cur => {
            const option = document.createElement('option');
            option.value = `${cur}/USDT`;
            list.appendChild(option);
        });
    } catch (err) {
        console.error('Ошибка загрузки валют', err);
    }
}
// Обработка формы прогнозирования
document.getElementById('forecastForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const exchange = document.getElementById('forecastExchange').value;
    const symbol = document.getElementById('forecastSymbol').value;
    
    if (!exchange || !symbol) {
        showError('Пожалуйста, заполните все обязательные поля');
        return;
    }
    
    showLoading('forecastLoading');
    updateForecastProgress(0, 'Загрузка исторических данных...');
    
    try {
        // Сначала получаем исторические данные
        const historicalResponse = await fetch(`/api/historical-data/${exchange}?symbol=${encodeURIComponent(symbol)}&hours=${document.getElementById('forecastHours').value}`);
        
        if (!historicalResponse.ok) {
            throw new Error(`Ошибка загрузки исторических данных: ${historicalResponse.status}`);
        }
        
        const historicalData = await historicalResponse.json();
        updateForecastProgress(50, 'Создание прогноза...');
        
        // Создаем прогноз
        const forecastData = {
            prices: historicalData.prices,
            methods: [document.getElementById('forecastMethod').value],
            horizons: [parseInt(document.getElementById('forecastHorizon').value)],
            lookback: 60
        };
        
        const forecastResponse = await fetch('/api/forecast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(forecastData)
        });
        
        if (!forecastResponse.ok) {
            throw new Error(`Ошибка создания прогноза: ${forecastResponse.status}`);
        }
        
        const forecastResult = await forecastResponse.json();
        updateForecastProgress(100, 'Прогноз создан');
        
        displayForecastResults(forecastResult, historicalData);
        showSuccess('Прогноз успешно создан!');
        
    } catch (error) {
        console.error('Ошибка:', error);
        showError('Ошибка при создании прогноза: ' + error.message);
    } finally {
        setTimeout(() => hideLoading('forecastLoading'), 500);
    }
});

function updateForecastProgress(percent, text) {
    const progressBar = document.getElementById('forecastProgressBar');
    const loadingText = document.getElementById('forecastLoadingText');
    
    if (progressBar) {
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
    }
    
    if (loadingText) {
        loadingText.textContent = text;
    }
}

let currentForecastData = null;
let currentHistoricalData = null;

function displayForecastResults(forecastData, historicalData) {
    const infoContainer = document.getElementById('forecastInfo');
    
    if (!forecastData.forecasts || forecastData.forecasts.length === 0) {
        document.getElementById('forecastChart').innerHTML = '<p class="text-muted">Не удалось создать прогноз</p>';
        return;
    }
    
    const forecast = forecastData.forecasts[0];
    
    // Сохраняем данные для валидации
    currentForecastData = forecastData;
    currentHistoricalData = historicalData;
    
    // Информация
    infoContainer.innerHTML = `
        <div class="row text-center">
            <div class="col-6">
                <h4 class="text-primary">${historicalData.prices.length}</h4>
                <small class="text-muted">Точек данных</small>
            </div>
            <div class="col-6">
                <h4 class="text-success">${forecast.horizon}</h4>
                <small class="text-muted">Горизонт прогноза</small>
            </div>
        </div>
        <hr>
        <div class="text-center">
            <h5 class="text-info">${forecast.method}</h5>
            <small class="text-muted">Метод прогнозирования</small>
        </div>
    `;
    
    // Создаем график
    createForecastChart(historicalData, forecastData);
}

function createForecastChart(historicalData, forecastData) {
    const chartContainer = document.getElementById('forecastChart');
    const prices = historicalData.prices;
    const forecast = forecastData.forecasts[0];
    
    // Создаем временные метки
    const timestamps = Array.from({length: prices.length}, (_, i) => i);
    
    // Создаем прогнозные значения
    const lastPrice = prices[prices.length - 1];
    const forecastChange = forecast.mu / 100;
    const forecastPrices = [];
    
    for (let i = 1; i <= forecast.horizon; i++) {
        const predictedPrice = lastPrice * (1 + forecastChange * i);
        forecastPrices.push(predictedPrice);
    }
    
    const forecastTimestamps = Array.from({length: forecast.horizon}, (_, i) => prices.length + i);
    
    // Создаем доверительные интервалы
    const confidence = forecast.confidence;
    const upperBound = forecastPrices.map(price => price * (1 + (1 - confidence) * 0.5));
    const lowerBound = forecastPrices.map(price => price * (1 - (1 - confidence) * 0.5));
    
    const traces = [
        {
            x: timestamps,
            y: prices,
            type: 'scatter',
            mode: 'lines',
            name: 'Исторические данные',
            line: {
                color: '#667eea',
                width: 3
            }
        },
        {
            x: forecastTimestamps,
            y: forecastPrices,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Прогноз',
            line: {
                color: '#28a745',
                width: 3,
                dash: 'dash'
            },
            marker: {
                size: 8,
                color: '#28a745'
            }
        },
        {
            x: forecastTimestamps.concat(forecastTimestamps.slice().reverse()),
            y: upperBound.concat(lowerBound.slice().reverse()),
            type: 'scatter',
            mode: 'lines',
            name: 'Доверительный интервал',
            line: {
                color: 'rgba(40, 167, 69, 0.2)',
                width: 0
            },
            fill: 'tonexty',
            fillcolor: 'rgba(40, 167, 69, 0.1)',
            showlegend: false
        }
    ];
    
    const layout = {
        title: `Прогноз цены: ${forecast.method.toUpperCase()}`,
        xaxis: { 
            title: 'Время',
            showgrid: true,
            gridcolor: '#f0f0f0'
        },
        yaxis: { 
            title: 'Цена',
            showgrid: true,
            gridcolor: '#f0f0f0'
        },
        height: 500,
        margin: { t: 50, b: 50, l: 50, r: 50 },
        legend: {
            x: 0.02,
            y: 0.98
        },
        annotations: [
            {
                x: forecastTimestamps[0],
                y: forecastPrices[0],
                text: `Прогноз: ${forecast.mu > 0 ? '+' : ''}${forecast.mu.toFixed(4)}%`,
                showarrow: true,
                arrowhead: 2,
                arrowcolor: '#28a745',
                ax: 20,
                ay: -30
            }
        ]
    };
    
    Plotly.newPlot(chartContainer, traces, layout, {responsive: true});
}

async function validateForecast() {
    if (!currentForecastData || !currentHistoricalData) {
        showError('Сначала создайте прогноз');
        return;
    }
    
    const validationHours = parseInt(document.getElementById('validationHours').value);
    const exchange = document.getElementById('forecastExchange').value;
    const symbol = document.getElementById('forecastSymbol').value;
    
    try {
        // Получаем новые данные для валидации
        const response = await fetch(`/api/historical-data/${exchange}?symbol=${encodeURIComponent(symbol)}&hours=${validationHours}`);
        
        if (!response.ok) {
            throw new Error(`Ошибка загрузки данных для валидации: ${response.status}`);
        }
        
        const validationData = await response.json();
        const forecast = currentForecastData.forecasts[0];
        
        // Сравниваем прогноз с реальными данными
        const lastPrice = currentHistoricalData.prices[currentHistoricalData.prices.length - 1];
        const actualPrices = validationData.prices;
        
        const forecastPrices = [];
        for (let i = 1; i <= Math.min(forecast.horizon, actualPrices.length); i++) {
            const predictedPrice = lastPrice * (1 + (forecast.mu / 100) * i);
            forecastPrices.push(predictedPrice);
        }
        
        // Вычисляем метрики точности
        const mape = calculateMAPE(actualPrices.slice(0, forecastPrices.length), forecastPrices);
        const rmse = calculateRMSE(actualPrices.slice(0, forecastPrices.length), forecastPrices);
        const accuracy = Math.max(0, 100 - mape);
        
        displayValidationResults(actualPrices, forecastPrices, mape, rmse, accuracy);
        
    } catch (error) {
        console.error('Ошибка валидации:', error);
        showError('Ошибка при валидации прогноза: ' + error.message);
    }
}

function calculateMAPE(actual, predicted) {
    let sum = 0;
    for (let i = 0; i < actual.length; i++) {
        sum += Math.abs((actual[i] - predicted[i]) / actual[i]);
    }
    return (sum / actual.length) * 100;
}

function calculateRMSE(actual, predicted) {
    let sum = 0;
    for (let i = 0; i < actual.length; i++) {
        sum += Math.pow(actual[i] - predicted[i], 2);
    }
    return Math.sqrt(sum / actual.length);
}

function displayValidationResults(actualPrices, forecastPrices, mape, rmse, accuracy) {
    const container = document.getElementById('validationResults');
    
    const accuracyClass = accuracy > 80 ? 'text-success' : accuracy > 60 ? 'text-warning' : 'text-danger';
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h3 class="${accuracyClass}">${accuracy.toFixed(1)}%</h3>
                        <p class="text-muted mb-0">Точность прогноза</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h3 class="text-info">${mape.toFixed(2)}%</h3>
                        <p class="text-muted mb-0">MAPE</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h3 class="text-warning">${rmse.toFixed(6)}</h3>
                        <p class="text-muted mb-0">RMSE</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h3 class="text-primary">${forecastPrices.length}</h3>
                        <p class="text-muted mb-0">Точек сравнения</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h6>Интерпретация точности:</h6>
            <ul>
                <li><strong>Точность ${accuracy.toFixed(1)}%:</strong> ${accuracy > 80 ? 'Отличная' : accuracy > 60 ? 'Хорошая' : 'Низкая'}</li>
                <li><strong>MAPE ${mape.toFixed(2)}%:</strong> ${mape < 5 ? 'Очень низкая ошибка' : mape < 10 ? 'Низкая ошибка' : 'Высокая ошибка'}</li>
                <li><strong>RMSE ${rmse.toFixed(6)}:</strong> ${rmse < 0.001 ? 'Очень низкая' : rmse < 0.01 ? 'Низкая' : 'Высокая'} волатильность ошибок</li>
            </ul>
        </div>
    `;
    
    // Создаем график сравнения
    createValidationChart(actualPrices, forecastPrices);
}

function createValidationChart(actualPrices, forecastPrices) {
    const timestamps = Array.from({length: Math.max(actualPrices.length, forecastPrices.length)}, (_, i) => i);
    
    const traces = [
        {
            x: timestamps.slice(0, actualPrices.length),
            y: actualPrices,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Реальные данные',
            line: {
                color: '#dc3545',
                width: 3
            },
            marker: {
                size: 6,
                color: '#dc3545'
            }
        },
        {
            x: timestamps.slice(0, forecastPrices.length),
            y: forecastPrices,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Прогноз',
            line: {
                color: '#28a745',
                width: 3,
                dash: 'dash'
            },
            marker: {
                size: 6,
                color: '#28a745'
            }
        }
    ];
    
    const layout = {
        title: 'Сравнение прогноза с реальными данными',
        xaxis: { 
            title: 'Время',
            showgrid: true,
            gridcolor: '#f0f0f0'
        },
        yaxis: { 
            title: 'Цена',
            showgrid: true,
            gridcolor: '#f0f0f0'
        },
        height: 400,
        margin: { t: 50, b: 50, l: 50, r: 50 },
        legend: {
            x: 0.02,
            y: 0.98
        }
    };
    
    // Добавляем график валидации под результатами
    const validationChartDiv = document.createElement('div');
    validationChartDiv.id = 'validationChart';
    document.getElementById('validationResults').appendChild(validationChartDiv);
    
    Plotly.newPlot('validationChart', traces, layout, {responsive: true});
}

function showLoading(elementId) {
    document.getElementById(elementId).style.display = 'block';
}

function hideLoading(elementId) {
    document.getElementById(elementId).style.display = 'none';
}

function showSuccess(message) {
    alert('✅ ' + message);
}

function showError(message) {
    alert('❌ ' + message);
}
</script>
{% endblock %} 